<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrfToken }}" />
    <title>{{ otherUser.username }} - Messages - X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "twitter-blue": "#1d9bf0",
                        "dark-gray": "#16181c",
                        "medium-gray": "#2f3336",
                        "light-gray": "#71767b"
                    }
                }
            }
        };
    </script>
</head>

<body class="bg-black text-white font-sans">
    <div class="flex min-h-screen">
        <!-- Sidebar gauche -->
        <div class="w-64 flex flex-col bg-black border-r border-gray-800 fixed h-full z-30">
            <div class="flex-1 flex flex-col min-h-0">
                <!-- Logo X -->
                <div class="mb-2 p-3">
                    <svg class="w-6 h-6 fill-white" viewBox="0 0 24 24">
                        <path
                            d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                    </svg>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 px-3 overflow-hidden">
                    <div class="space-y-0.5">
                        <!-- Maison -->
                        <a href="/dashboard"
                            class="flex items-center space-x-3 p-2 rounded-full hover:bg-gray-900 transition-all duration-200">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M12 9c-2.209 0-4 1.791-4 4s1.791 4 4 4 4-1.791 4-4-1.791-4-4-4zm9.707-5.293l-9-9a.999.999 0 00-1.414 0l-9 9A.999.999 0 003 5.414V19a3 3 0 003 3h4a1 1 0 001-1v-3a1 1 0 011-1h2a1 1 0 011 1v3a1 1 0 001 1h4a3 3 0 003-3V5.414a.999.999 0 00-.293-.707z" />
                            </svg>
                            <span class="text-lg">Maison</span>
                        </a>

                        <!-- Messages (active) -->
                        <a href="/messages"
                            class="flex items-center space-x-3 p-2 rounded-full bg-gray-900 text-twitter-blue transition-all duration-200">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <span class="text-lg font-bold">Messages</span>
                        </a>

                        <!-- Autres liens de navigation -->
                        <a href="/profile"
                            class="flex items-center space-x-3 p-2 rounded-full hover:bg-gray-900 transition-all duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <span class="text-lg">Profil</span>
                        </a>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="flex-1 ml-64 flex flex-col h-screen">
            <!-- En-tête de la conversation -->
            <div
                class="sticky top-0 bg-black bg-opacity-80 backdrop-blur-md border-b border-gray-800 p-4 flex items-center space-x-3">
                <a href="/messages" class="text-twitter-blue hover:text-blue-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                        <span class="text-sm font-bold">{{ otherUser.username.charAt(0).toUpperCase() }}</span>
                    </div>
                    <h1 class="text-xl font-bold">{{ otherUser.username }}</h1>
                </div>
            </div>

            <!-- Zone de notification pour nouveaux messages -->
            <div id="newMessageNotification"
                class="hidden bg-twitter-blue text-white px-4 py-2 text-center cursor-pointer hover:bg-blue-600 transition-colors"
                onclick="scrollToBottom()">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span id="newMessageText">Nouveau message reçu</span>
                </div>
            </div>

            <!-- Zone de messages -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                @if(messages && messages.length > 0)
                @each(message in messages)
                <div class="flex {{ message.senderId === currentUser.id ? 'justify-end' : 'justify-start' }}"
                    data-message-id="{{ message.id }}">
                    <div class="max-w-xs lg:max-w-md">
                        @if(message.senderId !== currentUser.id)
                        <!-- Message reçu -->
                        <div class="bg-gray-800 rounded-2xl rounded-bl-md p-3">
                            <p class="text-white">{{ message.content }}</p>
                            <p class="text-xs text-gray-400 mt-1">{{ message.createdAt.toFormat('HH:mm') }}</p>
                        </div>
                        @else
                        <!-- Message envoyé -->
                        <div class="bg-twitter-blue rounded-2xl rounded-br-md p-3">
                            <p class="text-white">{{ message.content }}</p>
                            <p class="text-xs text-blue-100 mt-1">{{ message.createdAt.toFormat('HH:mm') }}</p>
                        </div>
                        @endif
                    </div>
                </div>
                @endeach
                @else
                <div class="flex items-center justify-center h-full text-center text-gray-500">
                    <div>
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <h3 class="text-lg font-bold mb-2">Début de votre conversation</h3>
                        <p>Écrivez le premier message à {{ otherUser.username }} !</p>
                    </div>
                </div>
                @endif
            </div>

            <!-- Formulaire d'envoi -->
            <div class="border-t border-gray-800 p-4">
                <form id="messageForm" class="flex space-x-3">
                    {{ csrfField() }}
                    <input type="hidden" name="receiver_id" value="{{ otherUser.id }}">
                    <div class="flex-1">
                        <textarea id="messageInput" name="content" placeholder="Écrivez votre message..."
                            class="w-full bg-gray-900 border border-gray-700 rounded-2xl px-4 py-3 text-white placeholder-gray-400 focus:border-twitter-blue focus:outline-none resize-none"
                            rows="1" maxlength="500" required></textarea>
                    </div>
                    <button type="submit" id="sendButton"
                        class="bg-twitter-blue text-white px-6 py-3 rounded-full font-bold hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Envoyer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const messagesContainer = document.getElementById('messagesContainer');
            const sendButton = document.getElementById('sendButton');

            // Auto-resize du textarea
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';

                // Activer/désactiver le bouton d'envoi
                sendButton.disabled = this.value.trim().length === 0;
            });

            // Soumission du formulaire en AJAX
            messageForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const content = formData.get('content').trim();

                if (!content) return;

                // Désactiver temporairement le formulaire
                sendButton.disabled = true;
                messageInput.disabled = true;

                // Envoyer le message via AJAX
                fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                        'Accept': 'application/json',
                    },
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Ajouter le message à l'interface
                            addMessageToUI(data.message, true);

                            // Réinitialiser le formulaire
                            messageForm.reset();
                            messageInput.style.height = 'auto';

                            // Faire défiler vers le bas
                            scrollToBottom();
                        } else {
                            alert('Erreur lors de l\'envoi du message');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors de l\'envoi du message');
                    })
                    .finally(() => {
                        // Réactiver le formulaire
                        sendButton.disabled = false;
                        messageInput.disabled = false;
                        messageInput.focus();
                    });
            });

            // Fonction pour ajouter un message à l'interface
            function addMessageToUI(message, isSent) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;
                messageDiv.setAttribute('data-message-id', message.id);

                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                messageDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md">
            <div class="${isSent ? 'bg-twitter-blue' : 'bg-gray-800'} rounded-2xl ${isSent ? 'rounded-br-md' : 'rounded-bl-md'} p-3">
              <p class="text-white">${escapeHtml(message.content)}</p>
              <p class="text-xs ${isSent ? 'text-blue-100' : 'text-gray-400'} mt-1">${timeStr}</p>
            </div>
          </div>
        `;

                messagesContainer.appendChild(messageDiv);
            }

            // Fonction pour échapper le HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Variables pour les notifications
            let lastMessageId = 0;
            let isUserScrolledUp = false;
            let pollingInterval;
            const newMessageNotification = document.getElementById('newMessageNotification');
            const newMessageText = document.getElementById('newMessageText');

            // Fonction pour faire défiler vers le bas
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                hideNewMessageNotification();
            }

            // Fonction pour afficher la notification de nouveau message
            function showNewMessageNotification(count = 1) {
                if (count === 1) {
                    newMessageText.textContent = 'Nouveau message reçu';
                } else {
                    newMessageText.textContent = `${count} nouveaux messages reçus`;
                }
                newMessageNotification.classList.remove('hidden');
            }

            // Fonction pour masquer la notification
            function hideNewMessageNotification() {
                newMessageNotification.classList.add('hidden');
            }

            // Vérifier si l'utilisateur a fait défiler vers le haut
            messagesContainer.addEventListener('scroll', function () {
                const isAtBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 10;
                isUserScrolledUp = !isAtBottom;

                if (isAtBottom) {
                    hideNewMessageNotification();
                }
            });

            // Fonction pour vérifier les nouveaux messages
            function checkForNewMessages() {
                fetch(`/api/messages/{{ otherUser.id }}/new?lastId=${lastMessageId}`, {
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.messages && data.messages.length > 0) {
                            const isAtBottom = !isUserScrolledUp;
                            let newMessagesCount = 0;

                            data.messages.forEach(message => {
                                if (message.id > lastMessageId) {
                                    addMessageToUI(message, false);
                                    lastMessageId = message.id;
                                    newMessagesCount++;
                                }
                            });

                            if (newMessagesCount > 0) {
                                // Jouer un son de notification (optionnel)
                                playNotificationSound();

                                if (isAtBottom) {
                                    // L'utilisateur est en bas, faire défiler automatiquement
                                    setTimeout(() => scrollToBottom(), 100);
                                } else {
                                    // L'utilisateur a fait défiler vers le haut, afficher la notification
                                    showNewMessageNotification(newMessagesCount);
                                }

                                // Notification du navigateur
                                if (document.hidden && Notification.permission === 'granted') {
                                    new Notification(`Nouveau message de ${data.senderName}`, {
                                        body: data.messages[data.messages.length - 1].content,
                                        icon: '/favicon.ico'
                                    });
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la vérification des nouveaux messages:', error);
                    });
            }

            // Fonction pour jouer un son de notification
            function playNotificationSound() {
                // Créer un son simple avec Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Son de notification non disponible');
                }
            }

            // Initialiser le dernier ID de message
            function initializeLastMessageId() {
                const messageElements = messagesContainer.querySelectorAll('[data-message-id]');
                if (messageElements.length > 0) {
                    const lastElement = messageElements[messageElements.length - 1];
                    lastMessageId = parseInt(lastElement.dataset.messageId) || 0;
                }
            }

            // Démarrer le polling pour les nouveaux messages
            function startMessagePolling() {
                // Vérifier immédiatement, puis toutes les 2 secondes
                checkForNewMessages();
                pollingInterval = setInterval(checkForNewMessages, 2000);
            }

            // Arrêter le polling
            function stopMessagePolling() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
            }

            // Demander la permission pour les notifications
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // Initialisation
            initializeLastMessageId();

            // Faire défiler vers le bas au chargement
            scrollToBottom();

            // Focus sur l'input au chargement
            messageInput.focus();

            // Démarrer le polling
            startMessagePolling();

            // Arrêter le polling quand l'utilisateur quitte la page
            window.addEventListener('beforeunload', stopMessagePolling);

            // Reprendre le polling quand l'utilisateur revient sur la page
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    // Page cachée, continuer le polling mais moins fréquent
                    stopMessagePolling();
                    pollingInterval = setInterval(checkForNewMessages, 5000);
                } else {
                    // Page visible, reprendre le polling normal
                    stopMessagePolling();
                    startMessagePolling();
                }
            });
        });
    </script>
</body>

</html>